<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bat Swing Analyzer (WT901)</title>
<style>
  :root{
    --bg:#0b1020; --panel:#121833; --ink:#eef2ff; --muted:#9fb0e9; --accent:#7bb1ff;
    --good:#71f0a8; --warn:#ffd66e; --bad:#ff7a7a; --card:#0f1430; --outline:#202a56;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid #1b2450;background:linear-gradient(180deg,#0f1634,#0b1020)}
  h1{margin:0;font-size:18px;letter-spacing:.3px;font-weight:700}
  main{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:980px;margin:0 auto}
  /* Controls bar */
  .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{background:var(--accent);color:#041028;border:0;border-radius:12px;padding:10px 14px;font-weight:700}
  button.secondary{background:#24305f;color:var(--ink)}
  /* Collapsible sections */
  details{background:var(--panel);border:1px solid var(--outline);border-radius:12px;overflow:hidden}
  summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;align-items:center;gap:10px}
  summary::-webkit-details-marker{display:none}
  .twisty{width:10px;height:10px;border-right:2px solid var(--muted);border-bottom:2px solid var(--muted);
    transform:rotate(-45deg);transition:.2s ease;margin-left:4px}
  details[open] .twisty{transform:rotate(45deg)}
  .content{padding:10px 12px;border-top:1px solid var(--outline)}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input[type="number"],input[type="text"],textarea{
    width:100%;background:#0a0f22;border:1px solid #1d2750;border-radius:10px;color:var(--ink);
    padding:10px 12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace
  }
  .grid{display:grid;gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  @media (min-width:520px){ .grid.two{grid-template-columns:1fr 1fr} }
  /* Metric stage */
  .stage{display:grid;gap:10px}
  @media (min-width:520px){ .stage{grid-template-columns:1fr auto 1fr;align-items:stretch} }
  .metric-card{
    position:relative;background:var(--card);border:1px solid var(--outline);border-radius:14px;padding:8px;min-height:120px;
    display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden
  }
  .metric-title{font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.4px;margin-bottom:4px}
  .big-num{font-weight:900;letter-spacing:.5px;line-height:1}
  /* Extra-large for primary metrics */
  .big-num.primary{font-size:clamp(52px, 16vw, 80px)}
  /* Smaller for bat speed chip */
  .speed-chip{
    display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center;
    padding:10px 12px;border-radius:14px;background:#0e1531;border:1px dashed #2a3570;min-width:120px
  }
  .speed-label{font-size:11px;color:var(--muted);letter-spacing:.35px}
  .speed-value{font-size:20px;font-weight:800}
  /* Raw data panel (collapsed by default for mobile) */
  .data-panel{background:var(--panel);border:1px solid var(--outline);border-radius:12px;padding:10px}
  .hint{color:var(--muted);font-size:12px}
  .status{color:var(--muted);font-size:12px;margin-top:6px}
  /* Results list */
  .result{border-bottom:1px dashed #2a3570;padding:10px 0}
  .result:last-child{border-bottom:0}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  /* Range inline */
  .rangebox{display:flex;align-items:center;gap:8px}
  input[type="range"]{width:160px}
</style>
</head>
<body>
<header><h1>Bat Swing Analyzer – WT901 (knob-mount)</h1></header>

<main>

  <!-- Primary stage: Effort | Speed | Force -->
  <section class="stage" id="stage">
    <div class="metric-card" aria-live="polite">
      <div class="metric-title">Swing Effort</div>
      <div class="big-num primary" id="m_effort">—</div>
    </div>

    <div class="speed-chip">
      <div class="speed-label">Bat Speed (mph)</div>
      <div class="speed-value" id="m_speed">—</div>
    </div>

    <div class="metric-card" aria-live="polite">
      <div class="metric-title">Swing Force</div>
      <div class="big-num primary" id="m_force">—</div>
    </div>
  </section>

  <!-- Actions -->
  <section class="actions">
    <button id="analyze">Analyze</button>
    <button class="secondary" id="clear">Clear</button>
    <div class="rangebox" style="margin-left:auto">
      <label class="mono">“100” set at <span id="upLabel">15%</span> stronger</label>
      <input id="upPct" type="range" min="10" max="20" value="15" oninput="document.getElementById('upLabel').textContent=this.value+'%';"/>
    </div>
  </section>

  <!-- Collapsible: Equipment -->
  <details>
    <summary>
      <div class="twisty"></div>
      <strong>Equipment</strong><span class="hint" style="margin-left:6px"> (bat-specific inputs)</span>
    </summary>
    <div class="content grid two">
      <div>
        <label>Barrel distance from knob (meters)</label>
        <input id="barrel_m" type="number" step="0.01" value="0.58" title="Distance from knob sensor to sweet spot (~0.58 m typical)."/>
      </div>
      <div>
        <label>Bat weight (oz)</label>
        <input id="bat_oz" type="number" step="1" value="16" title="Total bat weight in ounces."/>
      </div>
    </div>
  </details>

  <!-- Collapsible: Detection Settings -->
  <details>
    <summary>
      <div class="twisty"></div>
      <strong>Detection Settings</strong><span class="hint" style="margin-left:6px"> (tweak if swings aren’t detected)</span>
    </summary>
    <div class="content grid two">
      <div>
        <label>Min swing duration (ms)</label>
        <input id="min_ms" type="number" step="10" value="80"/>
      </div>
      <div>
        <label>Gap bridge (ms)</label>
        <input id="gap_ms" type="number" step="5" value="40"/>
      </div>
      <div>
        <label>Noise floor cut (lowest %)</label>
        <input id="quiet_pct" type="number" step="5" value="30"/>
      </div>
    </div>
  </details>

  <!-- Raw data (collapsed by default – user opens only when needed) -->
  <details>
    <summary>
      <div class="twisty"></div>
      <strong>Paste Raw Sensor Export</strong> <span class="hint" style="margin-left:6px">(tab or comma separated; keep headers)</span>
    </summary>
    <div class="content">
      <textarea id="raw" placeholder="Paste your WT901 dump here…" rows="9"></textarea>
      <div class="hint" style="margin-top:6px">
        We auto-detect frame units, clip spikes, and fix shaky timestamps. No manual alignment needed.
      </div>
      <div id="status" class="status"></div>
    </div>
  </details>

  <!-- Results -->
  <section class="data-panel">
    <div class="hint">Detected swings</div>
    <div id="results" class="mono" style="margin-top:6px">—</div>
  </section>

</main>

<script>
/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function median(a){ if (!a.length) return 0; const s=[...a].sort((x,y)=>x-y); const m=Math.floor((s.length-1)/2); return s.length%2? s[m] : 0.5*(s[m]+s[m+1]); }
function mad(a){ if(!a.length) return 0; const m=median(a); return median(a.map(v=>Math.abs(v-m))); }
function rollingMax(arr, w){
  const out = new Array(arr.length).fill(-Infinity); let q=[];
  for (let i=0;i<arr.length;i++){
    while(q.length && arr[q[q.length-1]]<=arr[i]) q.pop();
    q.push(i);
    const start = i-w+1;
    if (q[0] < start) q.shift();
    if (i>=w-1) out[i] = arr[q[0]];
  }
  for (let i=0;i<w-1;i++) out[i]=out[w-1];
  return out;
}
function msToClock(ms){ const s = ms/1000; const m = Math.floor(s/60); const sec = (s%60).toFixed(3).padStart(6,'0'); return `${m}:${sec}`; }

/* Pretty count-up animation for numbers */
function countUp(el, to, opts={}){
  const {duration=500, decimals=0} = opts;
  const from = Number(el.dataset.value||0) || 0;
  const start = performance.now(); const diff = to - from;
  function frame(now){
    const t = clamp((now-start)/duration, 0, 1);
    const ease = t<.5? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
    const val = from + diff*ease;
    el.textContent = val.toFixed(decimals);
    if (t<1) requestAnimationFrame(frame); else { el.textContent = to.toFixed(decimals); el.dataset.value = to; }
  }
  requestAnimationFrame(frame);
}

/* ---------- Parsing ---------- */
function parseTS(t){
  // Robust: "YYYY-M-D HH:MM:SS.m[mm]" or "YYYY-M-D HH:MM:SS"
  const m = String(t).trim().match(/^(\d{4})-(\d{1,2})-(\d{1,2})[ T](\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,3}))?$/);
  if (m){
    const [_, Y, Mo, D, H, Mi, S, msRaw] = m;
    const ms = (msRaw ?? "0").padStart(3,"0");
    const iso = `${Y.padStart(4,"0")}-${Mo.padStart(2,"0")}-${D.padStart(2,"0")}T${H}:${Mi}:${S}.${ms}Z`;
    const d = new Date(iso);
    if (!isNaN(d)) return d.getTime();
  }
  const d2 = new Date(t); if (!isNaN(d2)) return d2.getTime();
  const num = Number(t); if (isFinite(num)) return num < 3e10 ? Math.round(num*1000) : Math.round(num);
  return NaN;
}

function parseTable(text){
  const lines = text.replace(/\r/g,'').split('\n').filter(s=>s.trim());
  if (!lines.length) return [];
  const hdr = lines[0].split(/\t|,/).map(h=>h.trim().toLowerCase());
  const idx = names => hdr.findIndex(h => names.some(n => h.includes(n)));
  const iTime = idx(['time']);
  const iAsX = idx(['asx','gx','gyro x']);
  const iAsY = idx(['asy','gy','gyro y']);
  const iAsZ = idx(['asz','gz','gyro z']);
  const iAx  = idx(['accx','ax','acc x','acx']);
  const iAy  = idx(['accy','ay','acc y','acy']);
  const iAz  = idx(['accz','az','acc z','acz']);

  const rows = [];
  for (let k=1;k<lines.length;k++){
    const cols = lines[k].split(/\t|,/);
    if (cols.length < 5) continue;
    rows.push({
      rawTime: (iTime>=0? cols[iTime] : String(k-1)).trim(),
      AsX: iAsX>=0? Number(cols[iAsX]) : NaN,
      AsY: iAsY>=0? Number(cols[iAsY]) : NaN,
      AsZ: iAsZ>=0? Number(cols[iAsZ]) : NaN,
      Ax:  iAx>=0?  Number(cols[iAx])  : NaN,
      Ay:  iAy>=0?  Number(cols[iAy])  : NaN,
      Az:  iAz>=0?  Number(cols[iAz])  : NaN,
    });
  }

  // Build time
  let allTS = rows.map(r=>parseTS(r.rawTime));
  if (allTS.some(v=>!isFinite(v))){
    const dtGuess = 10; // ms fallback
    allTS = rows.map((_,i)=> i*dtGuess);
  }
  const t0 = allTS[0] || 0; allTS = allTS.map(t=> Math.max(0, t - t0));

  // Unit guardrail: rad/s → deg/s if needed
  const gAbs = rows.map(r => Math.max(Math.abs(r.AsX||0),Math.abs(r.AsY||0),Math.abs(r.AsZ||0)));
  const gMax = Math.max(...gAbs, 0);
  const looksRad = gMax < 25;
  const toDeg = looksRad ? (180/Math.PI) : 1;

  const cleaned = rows.map((r,i)=>({
    t: allTS[i],
    gx: (r.AsX||0)*toDeg,
    gy: (r.AsY||0)*toDeg,
    gz: (r.AsZ||0)*toDeg,
    ax: (r.Ax||0),
    ay: (r.Ay||0),
    az: (r.Az||0)
  }));

  // Clip ridiculous spikes
  const cap = 1200;
  cleaned.forEach(r=>{
    r.gx = clamp(r.gx, -cap, cap);
    r.gy = clamp(r.gy, -cap, cap);
    r.gz = clamp(r.gz, -cap, cap);
  });

  return cleaned;
}

/* ---------- Detection & Metrics ---------- */
function averageDt(rows){
  let sum=0, cnt=0;
  for (let i=1;i<rows.length;i++){
    const d = rows[i].t - rows[i-1].t;
    if (d>0 && d<200) { sum+=d; cnt++; }
  }
  return cnt? sum/cnt : 10;
}
function timeToSamples(rows, ms){ const dt = averageDt(rows) || 10; return Math.max(1, Math.round(ms / dt)); }

function detectSwings(rows, opts){
  const {minMs=80, gapMs=40, quietPct=30} = opts;
  const gmag = rows.map(r=> Math.hypot(r.gx, r.gy, r.gz));
  const win = Math.max(2, Math.round(20 / (averageDt(rows)||10)));
  const gmax = rollingMax(gmag, win);

  const sorted = [...gmax].sort((a,b)=>a-b);
  const keep = Math.max(10, Math.floor(gmax.length * (quietPct/100)));
  const quiet = sorted.slice(0, keep);
  const base = median(quiet), qmad = mad(quiet), sigma = qmad * 1.4826;

  const th_on  = Math.max(base + 3.5*sigma, 180);
  const th_off = Math.max(base + 2.0*sigma, 120);
  const th_peak= Math.max(base + 5.0*sigma, 260);

  let inSwing=false, startIdx=null, lastIdx=null;
  const spans=[]; const maxGap = timeToSamples(rows, gapMs); const minSamples = timeToSamples(rows, minMs);

  for (let i=0;i<gmax.length;i++){
    const above = gmax[i] >= th_on; const below = gmax[i] <= th_off;
    if (!inSwing && above){ inSwing=true; startIdx=i; lastIdx=i; }
    else if (inSwing){
      if (!below) lastIdx=i;
      else {
        const gap = i - lastIdx;
        if (gap > maxGap){
          if (lastIdx - startIdx + 1 >= minSamples){
            const peak = Math.max(...gmax.slice(startIdx,lastIdx+1));
            if (peak >= th_peak) spans.push([startIdx,lastIdx]);
          }
          inSwing=false; startIdx=lastIdx=null;
        }
      }
    }
  }
  if (inSwing && lastIdx!=null && startIdx!=null){
    if (lastIdx - startIdx + 1 >= minSamples){
      const peak = Math.max(...gmax.slice(startIdx,lastIdx+1));
      if (peak >= th_peak) spans.push([startIdx,lastIdx]);
    }
  }
  return {spans, thresholds:{th_on, th_off, th_peak, base, sigma}};
}

function estimateMetrics(rows, span, barrelMeters){
  const [i0,i1] = span; const seg = rows.slice(i0, i1+1);
  const degPerS = seg.map(r=> Math.hypot(r.gx,r.gy,r.gz));
  const peakDegPerS = Math.max(...degPerS); const peakRadPerS = peakDegPerS * Math.PI/180;
  const batSpeed_mps = peakRadPerS * barrelMeters; const batSpeed_mph = batSpeed_mps * 2.236936;

  const gVec = seg.map(r=> Math.hypot(r.ax,r.ay,r.az));
  const baseG = Math.min(...gVec.slice(0, Math.max(1,Math.floor(gVec.length*0.3))));
  const dynG = gVec.map(g=> Math.max(0, g - baseG)); const peakG = Math.max(...dynG);

  return {t0:msToClock(rows[i0].t), t1:msToClock(rows[i1].t), batSpeed_mps, batSpeed_mph, peakG};
}

/* ---------- Main analyze ---------- */
function analyze(){
  const text = $("#raw").value.trim();
  if (!text){ $("#status").textContent = "Paste some data first."; return; }

  const barrelMeters = Number($("#barrel_m").value)||0.58;
  const batOz = Math.max(1, Number($("#bat_oz").value)||16);
  const batMassKg = batOz * 0.028349523125;

  const minMs  = Number($("#min_ms").value)||80;
  const gapMs  = Number($("#gap_ms").value)||40;
  const quietPct = clamp(Number($("#quiet_pct").value)||30, 10, 60);
  const TARGET_UP = 1 + (Number($("#upPct").value)||15)/100;

  const rows = parseTable(text);
  if (rows.length < 5){ $("#status").innerHTML = '<span style="color:var(--bad)">Could not parse rows. Ensure the first line is a header.</span>'; return; }

  // Fix non-monotonic timestamps by synthesizing regular dt
  const nonmono = rows.some((r,i)=> i>0 && rows[i].t <= rows[i-1].t);
  if (nonmono){ const dt = averageDt(rows) || 10; rows.forEach((r,i)=> r.t = i*dt); }

  const {spans, thresholds} = detectSwings(rows, {minMs, gapMs, quietPct});
  if (!spans.length){
    $("#results").innerHTML = `<div>No swings detected.<div class="hint">Try: lower <b>Min swing duration</b>, increase <b>Gap bridge</b>, or raise <b>Noise floor cut</b> (40–50%).</div></div>`;
    countUp($("#m_speed"), 0, {decimals:1}); $("#m_effort").textContent = "—"; $("#m_force").textContent = "—";
    $("#status").innerHTML = `Auto thresholds: on=${thresholds.th_on.toFixed(0)}°/s, off=${thresholds.th_off.toFixed(0)}°/s, peak≥${thresholds.th_peak.toFixed(0)}°/s.`;
    return;
  }

  // Compute metrics per span
  const rawScore = (mph,g)=> 1.5*mph + 10*g; // Effort base (independent of bat weight)
  const metrics = [];
  let bestRaw = 0;
  for (const span of spans){
    const m = estimateMetrics(rows, span, barrelMeters);
    m.raw = rawScore(m.batSpeed_mph, m.peakG);
    metrics.push(m);
    if (m.raw > bestRaw) bestRaw = m.raw;
  }

  // Normalization baselines
  const denomEffort = TARGET_UP * (bestRaw || 1);
  const refOz = 16, refMassKg = refOz * 0.028349523125;
  const bestSpeedMps = Math.max(...metrics.map(m=>m.batSpeed_mps)) || 0.01;

  // Aggregate + render list
  let bestSpeed=0, bestG=0, bestEffort=0, bestForce=0;
  const out=[];
  spans.forEach((span, idx)=>{
    const m = metrics[idx];
    const effort = clamp(Math.round(100 * m.raw / denomEffort), 0, 100);
    const forceIdx = clamp(Math.round(100 * ((batMassKg * m.batSpeed_mps) / (TARGET_UP * (refMassKg * bestSpeedMps)))) , 0, 100);

    bestSpeed = Math.max(bestSpeed, m.batSpeed_mph);
    bestG     = Math.max(bestG, m.peakG);
    bestEffort= Math.max(bestEffort, effort);
    bestForce = Math.max(bestForce, forceIdx);

    out.push(
      `<div class="result">
        <div><b>Swing ${idx+1}</b> <span class="hint">(${m.t0} → ${m.t1})</span></div>
        <div>Speed: ${m.batSpeed_mph.toFixed(1)} mph | g-dyn: ${m.peakG.toFixed(2)} | Effort: ${effort} | Force: ${forceIdx}</div>
      </div>`
    );
  });

  $("#results").innerHTML = out.join("");
  $("#status").innerHTML = `
    <div class="hint">Found <b>${spans.length}</b> swing(s). Auto thresholds:
      on=${thresholds.th_on.toFixed(0)}°/s, off=${thresholds.th_off.toFixed(0)}°/s, peak≥${thresholds.th_peak.toFixed(0)}°/s.
      dt≈${(averageDt(rows)||0).toFixed(1)} ms
    </div>`;

  // Animate hero numbers
  countUp($("#m_speed"), bestSpeed, {decimals:1});
  countUp($("#m_effort"), bestEffort, {decimals:0});
  countUp($("#m_force"),  bestForce,  {decimals:0});
}

/* ---------- Events ---------- */
$("#analyze").addEventListener("click", analyze);
$("#clear").addEventListener("click", ()=>{
  $("#raw").value = "";
  $("#results").textContent = "—";
  $("#m_speed").textContent = "—";
  $("#m_effort").textContent = "—";
  $("#m_force").textContent = "—";
  $("#status").textContent = "";
});
</script>
</body>
</html>
