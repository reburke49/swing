<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Swing Power</title>
<style>
  :root { --bg:#0b1020; --card:#121933; --ink:#e9eefc; --muted:#97a0c0; --accent:#7aa2ff; --ok:#28c76f; --warn:#ffcc00; --hot:#ff6464; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0e1530 100%);color:var(--ink)}
  header{padding:24px;text-align:center}
  header h1{margin:0 0 6px;font-size:1.7rem}
  header p{margin:0;color:var(--muted)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid #22305f;border-radius:12px;padding:16px}
  textarea{width:100%;min-height:200px;background:#0c1433;color:var(--ink);border:1px solid #22305f;border-radius:10px;padding:12px;resize:vertical}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0 0}
  .btn{background:var(--accent);color:#0b1020;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#273a7a;color:#d8e2ff}
  label{color:var(--muted);font-size:.92rem}
  input[type="file"]{display:none}
  input[type="number"],input[type="text"]{background:#0c1433;color:var(--ink);border:1px solid #22305f;border-radius:8px;padding:8px}
  select{background:#0c1433;color:var(--ink);border:1px solid #22305f;border-radius:8px;padding:8px}
  .drop{border:1px dashed #3550a8;padding:10px;border-radius:10px;text-align:center;color:var(--muted)}
  .big { display:grid; gap:8px; text-align:center; }
  .big .mph { font-size: clamp(40px, 8vw, 72px); font-weight:900; line-height:1.0 }
  .big .label { color: var(--muted); font-size:1rem }
  .gauge { height:18px; background:#0c1433; border:1px solid #22305f; border-radius:999px; overflow:hidden }
  .bar { height:100%; width:0%; background:var(--ok); transition: width .4s ease }
  .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center }
  .muted{color:var(--muted);font-size:.95rem}
  .split { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px }
  @media (max-width:1000px){ .split { grid-template-columns: 1fr; } }
  canvas{width:100%;height:220px;background:#0a1128;border:1px solid #22305f;border-radius:10px}
  details { margin-top:10px }
  summary { cursor:pointer; color:#cfd8ff }
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 10px;border-bottom:1px solid #22305f;text-align:left}
  th{color:#afbbdf;font-weight:600}
  .footer{text-align:center;color:var(--muted);padding:18px;font-size:.9rem}
</style>
</head>
<body>
<header>
  <h1>Swing Power</h1>
  <p>Paste WT901 export (TSV/CSV) or drop a file. Get one kid-friendly number: barrel speed at the sweet spot.</p>
</header>

<div class="wrap">

  <div class="card">
    <h2>Paste data or drop a file</h2>
    <div class="drop" id="dropZone">Drop .csv or .tsv here, or paste into the box</div>
    <textarea id="raw" placeholder="Headers like: time, AccX(g), AccY(g), AccZ(g), AsX(Â°/s), AsY(Â°/s), AsZ(Â°/s)..."></textarea>
    <div class="controls">
      <label class="row"><span>Sweet spot radius R (m):</span>
        <input id="radius" type="number" step="0.01" value="0.58" title="Distance from knob to sweet spot. 26&quot; bat â‰ˆ 0.66 m total, sweet spot ~0.58 m."/>
      </label>
      <label class="row"><span>Target mph (for 100 pts):</span>
        <input id="target" type="number" step="1" value="60" title="Score = mph / target Ã— 100"/>
      </label>
      <button class="btn" id="analyze">Analyze</button>
      <label for="file" class="btn secondary">Choose file</label><input id="file" type="file" accept=".csv,.tsv,.txt">
      <button class="btn secondary" id="download">Download JSON</button>
    </div>
    <p class="muted">Everything runs in your browser. Auto-detects swings; no alignment needed.</p>
  </div>

  <div class="split">
    <div class="card">
      <h2>Kid View</h2>
      <div class="row" style="margin-bottom:10px">
        <label class="row"><span>Pick swing:</span>
          <select id="swingSelect"><option value="-1" selected>Best swing</option></select>
        </label>
      </div>

      <div class="big">
        <div class="label" id="swingLabel">Swing Power</div>
        <div class="mph"><span id="mph">â€”</span> <span style="font-size:38%">mph</span></div>
        <div class="label"><span id="scoreText">Score: â€” / 100</span> <span id="emoji"></span></div>
        <div class="gauge"><div id="bar" class="bar"></div></div>
        <div class="label" id="tip">Try to beat your best!</div>
      </div>
    </div>

    <div class="card">
      <h2>Coach Details</h2>
      <details>
        <summary>Show charts & per-swing table</summary>
        <div style="margin-top:10px">
          <h3 style="margin:0 0 8px;font-size:1rem;color:#cfd8ff">Ï‰Ã—R speed (selected swing)</h3>
          <canvas id="speedChart" width="800" height="220"></canvas>
          <h3 style="margin:16px 0 8px;font-size:1rem;color:#cfd8ff">Dynamic g (selected swing)</h3>
          <canvas id="dynChart" width="800" height="220"></canvas>

          <table id="table">
            <thead><tr>
              <th>Swing</th><th>Start</th><th>Dur (s)</th><th>Robust Ï‰ (rad/s)</th><th>Sweet-spot mph</th><th>Max dyn g</th>
            </tr></thead>
            <tbody></tbody>
          </table>
          <p class="muted" id="meta"></p>
        </div>
      </details>
    </div>
  </div>

</div>

<div class="footer">Â© You. Static HTML. No data leaves your browser.</div>

<script>
/* ---------- helpers ---------- */
const byId = (id)=>document.getElementById(id);
const fmt = (x,d=2)=> (isFinite(x) ? Number(x).toFixed(d) : "â€”");
const mph = mps => mps*2.23693629;

function detectSep(text){
  const tabs=(text.match(/\t/g)||[]).length, commas=(text.match(/,/g)||[]).length;
  return tabs>=commas ? "\t" : ",";
}
function parseTable(text){
  const sep = detectSep(text);
  const lines = text.trim().split(/\r?\n/).filter(s=>s.trim().length>0);
  if(!lines.length) throw new Error("No rows.");
  const header = lines[0].split(sep).map(s=>s.trim());
  const rows = lines.slice(1).map(line=>line.split(sep));
  const map={}; header.forEach((h,i)=>map[h.toLowerCase()]=i);
  function findCol(opts){
    for(const o of opts){ if(map.hasOwnProperty(o.toLowerCase())) return map[o.toLowerCase()]; }
    for(const k in map){ for(const o of opts){ if(k.replace(/\s+/g,'').includes(o.toLowerCase().replace(/\s+/g,''))) return map[k]; } }
    throw new Error("Missing column: "+opts.join(", "));
  }
  const idx = {
    time: findCol(["time","timestamp"]),
    ax: findCol(["AccX(g)","accx","ax","acc_x"]),
    ay: findCol(["AccY(g)","accy","ay","acc_y"]),
    az: findCol(["AccZ(g)","accz","az","acc_z"]),
    gx: findCol(["AsX(Â°/s)","GyroX(Â°/s)","gx","gyro_x"]),
    gy: findCol(["AsY(Â°/s)","GyroY(Â°/s)","gy","gyro_y"]),
    gz: findCol(["AsZ(Â°/s)","GyroZ(Â°/s)","gz","gyro_z"])
  };
  const out={time:[],ax:[],ay:[],az:[],gx:[],gy:[],gz:[]};
  for(const r of rows){
    const t=r[idx.time], ax=parseFloat(r[idx.ax]), ay=parseFloat(r[idx.ay]), az=parseFloat(r[idx.az]),
          gx=parseFloat(r[idx.gx]), gy=parseFloat(r[idx.gy]), gz=parseFloat(r[idx.gz]);
    if([ax,ay,az,gx,gy,gz].some(v=>!isFinite(v))) continue;
    out.time.push(new Date(t)); out.ax.push(ax); out.ay.push(ay); out.az.push(az);
    out.gx.push(gx); out.gy.push(gy); out.gz.push(gz);
  }
  if(out.time.length<3) throw new Error("Not enough numeric rows.");
  return out;
}
function movingAverage(a,n=3){
  if(n<=1) return a.slice();
  const o=new Array(a.length).fill(0), w=new Array(n).fill(1/n);
  for(let i=0;i<a.length;i++){ let s=0,c=0;
    for(let k=0;k<n;k++){ const j=i+k-Math.floor(n/2); if(j>=0&&j<a.length){ s+=a[j]*w[k]; c+=w[k]; } }
    o[i]=s/(c||1);
  } return o;
}
function percentile(arr,p){
  const v=arr.slice().sort((a,b)=>a-b); if(!v.length) return NaN;
  const r=(p/100)*(v.length-1), i=Math.floor(r), f=r-i;
  return (i+1<v.length)? v[i]*(1-f)+v[i+1]*f : v[i];
}
function median(arr){ const v=arr.slice().sort((a,b)=>a-b); const n=v.length; return n%2? v[(n-1)/2] : (v[n/2-1]+v[n/2])/2; }
function mad(arr){ const m=median(arr); return median(arr.map(x=>Math.abs(x-m))); }
function diffSeconds(ts){
  const d=[]; for(let i=1;i<ts.length;i++) d.push((ts[i]-ts[i-1])/1000);
  d.sort((a,b)=>a-b); return d.length? d[Math.floor(d.length/2)] : 0.01;
}

/* ---------- metrics & segmentation ---------- */
function computeOmega(time, gx,gy,gz, smoothN=3){
  const deg = gx.map((_,i)=>Math.hypot(gx[i],gy[i],gz[i]));
  return movingAverage(deg, smoothN).map(x=>x*Math.PI/180);
}
function segmentSwingsAuto(time, omega){
  const wAbs = omega.map(Math.abs);
  const m = median(wAbs), s = 1.4826*mad(wAbs) || (percentile(wAbs,75)-percentile(wAbs,25))/1.349 || 1;
  const high = m + 3.0*s, low = m + 1.8*s;  // hysteresis
  const ts = time.map(t=>t.getTime());
  const dt = diffSeconds(ts);
  const minDur = Math.max(0.14, 6*dt), gapDur = Math.max(0.25, 10*dt);
  const minLen = Math.max(3, Math.round(minDur/dt)), gapLen = Math.max(3, Math.round(gapDur/dt));
  const segs=[]; let inSwing=false,start=0,below=0;
  for(let i=0;i<wAbs.length;i++){
    if(!inSwing){ if(wAbs[i]>=high){ inSwing=true; start=i; below=0; } }
    else{
      if(wAbs[i]<=low){ below++; if(below>=gapLen){ const end=Math.max(start,i-below+1); if(end-start+1>=minLen) segs.push([start,end]); inSwing=false; below=0; } }
      else below=0;
    }
  }
  if(inSwing){ const end=wAbs.length-1; if(end-start+1>=minLen) segs.push([start,end]); }
  // require robust strength
  const strong = segs.filter(([a,b])=> percentile(wAbs.slice(a,b+1),98) >= (m + 2.0*s));
  // merge tiny gaps
  const merged=[]; for(const sEG of strong){ if(!merged.length){ merged.push(sEG); continue; }
    const last=merged[merged.length-1]; const gapSamp=sEG[0]-last[1]-1;
    if(gapSamp<=Math.round(0.12/dt)) last[1]=sEG[1]; else merged.push(sEG);
  }
  return {segments:merged, thresholds:{median:m, sigma:s, high, low, dt}};
}
function computeSwingMetrics(time, ax,ay,az, omega, R, robustPct=98){
  const accMag = ax.map((_,i)=>Math.hypot(ax[i],ay[i],az[i]));
  const dynG = accMag.map(x=>Math.max(0,x-1.0));
  const omegaAbsMax = Math.max(...omega);
  const omegaRobust = percentile(omega, robustPct);
  const mphSweet = mph(omegaRobust * R);
  return {
    time, dynG, omega, omegaRobust,
    mphSweet, mphAbs: mph(omegaAbsMax * R),
    maxDynG: Math.max(...dynG),
    dur: (time.at(-1)-time[0])/1000
  };
}

/* ---------- simple charts ---------- */
function lineChart(canvas, t, y, label=""){
  const ctx=canvas.getContext("2d"), W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H); if(!y.length) return;
  const t0=t[0].getTime(), xs=y.map((_,i)=>(t[i].getTime()-t0)/1000);
  const minY=Math.min(...y), maxY=Math.max(...y), pad=(maxY-minY)*0.1||1, yMin=minY-pad, yMax=maxY+pad;
  ctx.strokeStyle="#27408f"; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(50,10); ctx.lineTo(50,H-30); ctx.lineTo(W-10,H-30); ctx.stroke();
  ctx.fillStyle="#98a7d8"; ctx.font="12px system-ui,sans-serif"; ctx.fillText(label,10,14);
  const X=x=>50+(W-60)*(x/(xs.at(-1)||1)), Y=v=>(H-30)-(H-40)*((v-yMin)/(yMax-yMin||1));
  ctx.strokeStyle="#7aa2ff"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(X(xs[0]),Y(y[0])); for(let i=1;i<y.length;i++) ctx.lineTo(X(xs[i]),Y(y[i])); ctx.stroke();
  ctx.fillStyle="#6e7fb7"; const xt=6; for(let i=0;i<=xt;i++){ const x=(xs.at(-1)||1)*i/xt, px=X(x); ctx.beginPath(); ctx.moveTo(px,H-30); ctx.lineTo(px,H-34); ctx.strokeStyle="#27408f"; ctx.stroke(); ctx.fillText((x).toFixed(2)+"s",px-14,H-10); }
}

/* ---------- UI glue ---------- */
let dataset=null, swings=[], perSwing=[], bestIdx=-1;

function colorForScore(s){
  if(s>=90) return {c:"var(--hot)",emoji:"ðŸ”´ Power swing!"};
  if(s>=60) return {c:"var(--ok)",emoji:"ðŸŸ¢ Good cut!"};
  if(s>=30) return {c:"var(--warn)",emoji:"ðŸŸ¡ Warm-up"};
  return {c:"#7aa2ff",emoji:"ðŸ”µ Easy swing"};
}
function updateKidView(idx){
  if(perSwing.length===0){ byId("mph").textContent="â€”"; byId("scoreText").textContent="Score: â€” / 100"; byId("emoji").textContent=""; byId("bar").style.width="0%"; return; }
  if(idx<0) idx = bestIdx >=0 ? bestIdx : 0;
  const R = parseFloat(byId("radius").value||"0.58"), tgt = Math.max(1, parseFloat(byId("target").value||"60"));
  const mphSweet = perSwing[idx].mphSweet;
  const score = Math.max(0, Math.min(100, Math.round(mphSweet / tgt * 100)));
  const {c,emoji} = colorForScore(score);
  byId("swingLabel").textContent = `Swing ${idx+1}`;
  byId("mph").textContent = Math.round(mphSweet);
  byId("scoreText").textContent = `Score: ${score} / 100`;
  byId("emoji").textContent = emoji;
  const bar = byId("bar");
  bar.style.width = `${score}%`;
  bar.style.background = c;

  // charts (coach view)
  lineChart(byId("speedChart"), perSwing[idx].time, perSwing[idx].omega.map(w=>w*R), "m/s");
  lineChart(byId("dynChart"), perSwing[idx].time, perSwing[idx].dynG, "dynamic g");
}

function buildTable(meta){
  const tb = byId("table").querySelector("tbody");
  tb.innerHTML = "";
  perSwing.forEach((s,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>Swing ${i+1}</td>
      <td>${new Date(s.time[0]).toLocaleTimeString()}</td>
      <td>${fmt(s.dur,2)}</td>
      <td>${fmt(s.omegaRobust,2)}</td>
      <td>${fmt(s.mphSweet,1)}</td>
      <td>${fmt(s.maxDynG,2)}</td>`;
    tb.appendChild(tr);
  });
  byId("meta").textContent = `Swings: ${perSwing.length}. dtâ‰ˆ${fmt(meta.dt*1000,1)} ms. Auto thresholds: median=${fmt(meta.median,1)}, high=${fmt(meta.high,1)}, low=${fmt(meta.low,1)}.`;
  const sel = byId("swingSelect");
  sel.innerHTML = `<option value="-1" selected>Best swing</option>`;
  perSwing.forEach((_,i)=>{ const o=document.createElement("option"); o.value=String(i); o.textContent=`Swing ${i+1}`; sel.appendChild(o); });
}

function analyzeText(text){
  // parse
  const d = parseTable(text); dataset = d;
  // compute omega (auto smoothing 3)
  const omega = computeOmega(d.time, d.gx,d.gy,d.gz, 3);
  const seg = segmentSwingsAuto(d.time, omega);

  // per-swing metrics
  const R = parseFloat(byId("radius").value||"0.58");
  perSwing = seg.segments.map(([s,e])=>{
    const sub = {
      time: d.time.slice(s,e+1),
      ax: d.ax.slice(s,e+1), ay: d.ay.slice(s,e+1), az: d.az.slice(s,e+1)
    };
    const m = computeSwingMetrics(sub.time, sub.ax, sub.ay, sub.az, omega.slice(s,e+1), R, 98);
    return m;
  });

  // pick best (highest mph)
  bestIdx = perSwing.length ? perSwing.reduce((b,s,i)=> s.mphSweet > perSwing[b].mphSweet ? i : b, 0) : -1;

  // populate UI
  buildTable({dt: seg.thresholds.dt, median: seg.thresholds.median, high: seg.thresholds.high, low: seg.thresholds.low});
  updateKidView(-1);
}

byId("analyze").addEventListener("click", ()=>{
  const text=byId("raw").value;
  if(!text.trim()){ alert("Paste your data first."); return; }
  try{ analyzeText(text); }catch(e){ alert("Parse error: "+e.message); }
});
byId("swingSelect").addEventListener("change", e=>{
  const v = parseInt(e.target.value,10);
  updateKidView(isNaN(v)?-1:v);
});
byId("radius").addEventListener("change", ()=> updateKidView(byId("swingSelect").value|0));
byId("target").addEventListener("change", ()=> updateKidView(byId("swingSelect").value|0));

/* drag & drop + file */
const drop=byId("dropZone");
drop.addEventListener("dragover", e=>{ e.preventDefault(); drop.style.background="#0d1742"; });
drop.addEventListener("dragleave", ()=> drop.style.background="");
drop.addEventListener("drop", e=>{
  e.preventDefault(); drop.style.background="";
  const f=e.dataTransfer.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=ev=>byId("raw").value=ev.target.result; r.readAsText(f);
});
byId("file").addEventListener("change", e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=ev=>byId("raw").value=ev.target.result; r.readAsText(f);
});

/* export */
byId("download").addEventListener("click", ()=>{
  if(!perSwing.length){ alert("Analyze first."); return; }
  const R = parseFloat(byId("radius").value||"0.58");
  const rpt = {
    sweet_spot_radius_m: R,
    target_mph_for_100: parseFloat(byId("target").value||"60"),
    swings: perSwing.map((s,i)=>({
      label:`Swing ${i+1}`,
      start_iso: new Date(s.time[0]).toISOString(),
      duration_s: +s.dur.toFixed(3),
      mph_sweet: +s.mphSweet.toFixed(2),
      mph_absmax: +s.mphAbs.toFixed(2),
      peak_omega_robust_rad_s: +s.omegaRobust.toFixed(2),
      max_dynamic_g: +s.maxDynG.toFixed(2)
    })),
    best_index: bestIdx
  };
  const blob=new Blob([JSON.stringify(rpt,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="swing_report.json"; a.click();
});
</script>
</body>
</html>
